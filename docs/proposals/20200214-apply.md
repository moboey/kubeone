# KubeOne Reconciliation Process (`kubeone apply`)

**Author:** Marko MudriniÄ‡ ([@xmudrii](https://github.com/xmudrii))  
**Status:** **Draft** | Review | Final  
**Created:** 2020-02-14  
**Last updated:** 2020-02-14

## Abstract

KubeOne supports installing/provisioning and upgrading clusters, with repairs being
planned as well. Currently, all features are implemented as dedicated subcommands,
for example `install` and `upgrade`. Instead of having a subcommand for each feature,
we want to implement the reconciliation process under the `apply` subcommand. `apply`
would analyze the provided cluster configuration file (the expected state) and the cluster
actual state, and based on the difference take the appropriate steps.
The appropriate steps can be operations such as install, upgrade, repair cluster,
apply missing manifest, create or rotate the worker nodes...

## Goals

* Implement the `apply` subcommand
  * Implement probes to detect the state of the cluster
  * Implement the logic to take the appropriate steps depending on
  the results returned by probes (e.g. install or upgrade the cluster)
* Decide on deprecating existing subcommands (`install` and `upgrade`)

## Non-goals

* Implement the repair process

## Glossary

* _leader instance_: a VM instance, where cluster PKI get generated and first control-plane components are launched at cluster initialization time.

## Implementation

The reconciliation process is going to be invoked by the `kubeone apply` command.
The command takes the KubeOne cluster configuration manifest, which represents the
expected state, and optionally Terraform state and set of flags and options.

Example: `kubeone apply config.yaml -t tfstate.json`

Once invoked, the command takes the following steps:
* parse the provided cluster configuration to determine the expected state
* run probes to determine the actual state of the cluster
* run specific set of actions to turn actual state into the expected state (reconcile)
* re-run probes to ensure that actual and expected states of the cluster match

### Probes

Probes are used to determine the actual state of the cluster. They are implemented
as scripts to be executed over SSH or as Kubernetes API requests. For example, a 
probe can check is `kubelet` running on a node or does all required pods exist.

The following probes **must** be implemented:

* is cluster provisioned
* is specific node provisioned, ready, and responsive
* is the actual Kubernetes version matching the desired version
* are critical control plane pods running and healthy
* is `etcd` ring healthy and in the expected state (all control plane nodes joined)
* is the actual cluster configuration matching the expected cluster configuration
* are worker nodes running and responsive

Some of the mentioned checks are already implemented in some form in `upgrade` and
`status` subcommands.

### Reconciling The Cluster

Depending on the actual state of the cluster determined by probes, KubeOne will try
to modify the cluster to match the expected state.

Some actions will be taken automatically, however, it is not planned to fully-automate
all actions. For example, if `kubeone apply` determines that a node needs to be repaired,
it would be up to the operator to create a new VM, update the cluster configuration
(or Terraform state) and then run `kubeone apply` again.

The following table shows some common actions that might be taken depending on the actual
cluster state:

* install the cluster (currently `kubeone install`):
  * triggered if `is cluster provisioned` fails.
  * triggered if `is specific node provisioned, ready, and responsive`.
* upgrade the cluster (currently `kubeone upgrade`):
  * triggered if `is actual Kubernetes version matching the desired version` fails
* repair and install the cluster (currently, repair has to be done manually):
  * triggered if one of the following checks fail on one of control plane nodes:
    * `are critical control plane pods running and healthy`
    * `is etcd ring healthy and in the expected state (all control plane nodes joined)`
* reconfigure the cluster:
  * triggered if `is the actual cluster configuration matching the expected cluster configuration` fails
* rotate worker nodes:
  * triggered if `are worker nodes running and responsive` fails

## Tasks & Efforts

* TBD
